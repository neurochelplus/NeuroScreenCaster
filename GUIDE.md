# GUIDE: Автозумы в текущей версии NeuroScreenCaster

Этот документ описывает **фактическую** логику автозумов в текущем коде проекта.

## 1. Где формируются автозумы

- После остановки записи (`stop_recording`) телеметрия событий передается в `build_smart_camera_segments`.
- Сегменты записываются в `project.json` в `timeline.zoomSegments`.
- Основная логика находится в:
  - `src-tauri/src/algorithm/camera_engine.rs`
  - `src-tauri/src/commands/capture.rs`
  - `src/screens/Edit.tsx` (preview и ручная правка)

## 2. Структура зум-сегмента

В `ZoomSegment` используются поля:

- `startTs`, `endTs` — границы сегмента
- `initialRect`, `targetPoints` — целевой вьюпорт
- `spring` — параметры пружины камеры
- `mode`:
  - `fixed` (залоченная камера)
  - `follow-cursor` (следование за курсором)
- `trigger`:
  - `auto-click`
  - `auto-scroll`
  - `manual`
- `isAuto` — авто или ручной сегмент

Новые auto-сегменты сейчас создаются как:
- `mode = fixed`
- `trigger = auto-click`

## 3. Триггеры автозума (текущая реализация)

### 3.1 Активация по кликам

- По умолчанию авто-зум включается только если есть **минимум 2 клика в окне 3 секунды**.
- Одиночный клик по умолчанию игнорируется (анти-спам).

### 3.2 Кластеризация быстрых кликов

- Клики с интервалом `<= 300ms` объединяются в один кластер.
- Для кластера:
  - фокус по позиции считается от среднего центра серии,
  - последний клик выступает финальным якорем.

### 3.3 Анти-спам по времени

- Между стартами новых авто-переходов выдерживается минимум `2000ms`.

### 3.4 Pre-roll (предвосхищение)

- Может начать переход раньше клика (до `400ms`), если скорость курсора падает ниже порога (`0.55 px/ms`).
- При высокой скорости непосредственно перед кликом pre-roll не применяется.

## 4. Расчет кадрирования и зума

### 4.1 Семантическая цель

- Если есть `uiContext.boundingRect`, камера центрируется по нему.
- К прямоугольнику применяется padding (`20%`) и подгонка под аспект.
- Если boundingRect отсутствует — fallback: центр по клику, zoom `2.0x`.

### 4.2 Ограничение зума

- Любой auto-target в lock-режиме ограничивается:
  - `min = 1.0x`
  - `max = 2.5x`

### 4.3 Containment Test

- В lock-режиме перед новым ретаргетом проверяется безопасная зона:
  - берется текущий viewport,
  - вычитается margin `15%`,
  - если новый target полностью внутри safe-zone, камера **не перенацеливается**.

## 5. Состояния камеры

Реализованы два состояния:

- `FreeRoam`
- `LockedFocus`

### 5.1 FreeRoam

- Базовый zoom: `1.0x`.
- Движение цели только при выходе курсора за dead-zone (`40%` центральной области).

### 5.2 LockedFocus

- Камера удерживает target сегмента.
- Для zoom-состояния soft-zone фактически отключен: применяется логика hard-edge.
- Если курсор пробивает hard-edge (`45%` от центра viewport), включается pan:
  - скорость до `1200 px/s`.

### 5.3 Выход из lock

- По дистанции: курсор ушел слишком далеко (`80%` диагонали экрана).
- По таймауту lock-окна.

## 6. Скролл в зуме

### 6.1 Локальный скролл

- В `LockedFocus` каждый scroll сдвигает `Y_target` камеры (синхронный pan с контентом).

### 6.2 Глобальный скролл (zoom-out)

- Ведется scroll-сессия.
- Сессия сбрасывается после `300ms` тишины.
- Если выполнено одно из условий:
  - непрерывный scroll `>= 3000ms`
  - суммарная |dy| `>= 150%` высоты экрана
- то выполняется принудительный выход в `FreeRoam` (возврат контекста).

## 7. Пружинная динамика

- Фиксированный шаг интеграции: `8ms`.
- Параметры по умолчанию:
  - `mass = 1`
  - `stiffness = 170`
  - `damping = 26` (критическое демпфирование)
- Отдельные пружины для `x`, `y`, `zoom`.

## 8. Как формируются targetPoints

- `targetPoints` собираются из samples lock-состояния.
- Шаг семплирования: примерно каждые `75ms` (плюс начало/конец сегмента).

## 9. Режимы в редакторе

### 9.1 Переключение режима сегмента

В Edit-screen у выбранного сегмента доступно:

- `Camera Mode = Locked` (`fixed`)
- `Camera Mode = Follow cursor` (`follow-cursor`)

### 9.2 Follow в превью

Для `follow-cursor` в редакторе runtime-таргеты строятся по курсору с зонной логикой:

- dead-zone: `25%`
- hard-edge: `45%`
- max speed: `800 px/s`
- шаг дискретизации: `75ms`

### 9.3 Сохранение follow

- При сохранении проекта targetPoints для follow-сегментов материализуются в `project.json`.
- Это нужно, чтобы экспорт повторял ту же траекторию.

## 10. Что пока не реализовано из расширенного spec

В текущей версии отсутствуют/не доведены до полноценного прод-режима:

- триггеры по смене окна/URL/детекции текста как отдельные auto-пайплайны
- отдельная drag-ветка поведения камеры
- автоматическое назначение `follow-cursor` при автогенерации (сейчас auto = `fixed`)
- content-aware/AI zoom

