# PLAN: NeuroScreenCaster (Windows-first, Full MVP)

## 1. Цель и рамки

Создать рабочий аналог ScreenStudio/CANVID для Windows с архитектурой Metadata-First:

1. Запись "чистого" видео без курсора.
2. Параллельный сбор телеметрии (мышь/клавиатура/клики + контекст UI-элементов).
3. Неразрушающий редактор (виртуальная камера, авто-зум, сглаженный курсор, ручная правка зумов).
4. Экспорт финального MP4.

### Включено в MVP

- Windows-only (WGC + UI Automation).
- Full MVP из документа: capture, auto-zoom, cursor smoothing, manual zoom editing, background/cursor settings, export.
- Выполнение задач параллельно через AI-агентов.
- Тесты и QA после реализации модулей.

### Не включено в MVP (чтобы избежать расползания scope)

- macOS реализация.
- Webcam/audio/AI post-processing.
- Multi-monitor, 4K/60fps как обязательные цели.

---

## 2. Технический стек

### Backend (Desktop/Core)

- Rust + Tauri v2.
- Захват экрана: `windows-capture` (WGC, курсор выключен).
- Хуки ввода: `rdev`.
- Контекст UI: `uiautomation`.
- IPC/параллелизм: `tauri::Channel`, `tokio`, каналы сообщений.

### Frontend (Editor UI)

- React + TypeScript.
- Таймлайн и панель параметров.
- Превью композиции (виртуальная камера + курсор).

### Видео рендер и экспорт

- Remotion для композиции сцены.
- FFmpeg (sidecar) для финальной сборки/кодирования MP4.

### Хранение состояния проекта

- `project.json` (источники, таймлайн, параметры рендера).
- `events.json` (телеметрия).

---

## 3. Архитектура модулей

1. `capture-core` (Rust):
   - Запуск/остановка записи.
   - Чистый видеопоток (без курсора).
   - Буферизация и сохранение в raw MP4.

2. `telemetry-core` (Rust):
   - Глобальные события мыши/клавиатуры.
   - На click: асинхронное получение `bounding rect` через UI Automation.
   - Таймстемпы и синхронизация с видео.

3. `project-core` (Rust/TS):
   - Схемы и валидация `project.json` / `events.json`.
   - Загрузка/сохранение/миграции формата.

4. `algorithm-core` (TS/Rust):
   - Кластеризация кликов для авто-зума.
   - RDP упрощение пути курсора.
   - Catmull-Rom интерполяция траектории.

5. `editor-ui` (React):
   - Таймлайн, ручная правка zoom-сегментов.
   - Настройки фона/курсора.
   - Превью композиции.

6. `export-core` (Tauri + Remotion + FFmpeg):
   - Рендер кадров композиции.
   - Сборка MP4.

---

## 4. Поэтапный план разработки

## Этап 0. Инициализация проекта (Wave 1) — Выполнено

### Задачи

- [x] Создать базовый Tauri v2 проект (`src-tauri` + React UI).
- [x] Определить структуру папок модулей.
- [x] Настроить sidecar FFmpeg и базовые команды IPC.

### Результат

- Запускаемое desktop-приложение с каркасом экранов: Record / Edit / Export.

### Критерий готовности

- Приложение запускается, команды start/stop заглушки работают.

---

## Этап 1. Контракты данных и синхронизация (Wave 1) — Выполнено

### Задачи

- [x] Зафиксировать JSON-схемы:
  - [x] `events.json`
  - [x] `project.json`
- [x] Ввести единый формат времени (ms + стабильный clock source).
- [x] Добавить версионирование схем (`schemaVersion`).

### Результат

- Контракт между recorder/editor/export стабилен и валидируем.

### Критерий готовности

- Файлы проходят JSON-schema валидацию.

---

## Этап 2. Recorder: видео без курсора (Wave 2) — Выполнено

### Задачи

- [x] Реализовать захват через WGC (`windows-capture`).
- [x] Отключить системный курсор в потоке захвата.
- [x] Сохранять raw MP4 с таймкодами.
- [x] Обработать stop/error/permission сценарии.
- [x] Бандлить FFmpeg как sidecar (`src-tauri/binaries/`), не требовать из PATH.

### Результат

- Чистый видеофайл записи экрана, пригодный для пост-композитинга.

### Критерий готовности

- Видео воспроизводится, курсор отсутствует, запись стабильна минимум 10 минут.

---

## Этап 3. Telemetry Logger (Wave 2) — Выполнено

### Задачи

- [x] Поднять глобальные хуки ввода (`rdev`).
- [x] Логировать `move/click/scroll/key` события.
- [x] На `click` получать UI-контекст через `uiautomation` (`bounding rectangle`, имя приложения).
- [x] Сериализовать в `events.json`.

### Результат

- Полный поток телеметрии, синхронизированный с видео.

### Критерий готовности

- Для тестового сценария (10+ кликов) события и координаты корректны, контекст заполняется или fallback-ится.

---

## Этап 4. Алгоритмы Auto-Zoom и Cursor Smoothing (Wave 3) — Выполнено

### Задачи

- Авто-зум:
  - кластеризация серий кликов,
  - расчет target viewport + padding,
  - lookahead,
  - easing переходов.
- Сглаживание курсора:
  - RDP упрощение,
  - Catmull-Rom интерполяция,
  - попадание в click points без смещений.

### Результат

- Из сырой телеметрии получаем zoom-сегменты и плавную траекторию курсора.

### Критерий готовности

- На эталонных сценариях автозум не дергается, курсор визуально гладкий и точный в точках клика.

---

## Этап 5. Editor UI (Wave 3-4) — Выполнено

### Задачи

- Экран редактирования с превью композиции.
- Таймлайн зумов:
  - отображение auto zoom сегментов,
  - ручная правка длительности,
  - изменение target области.
- Настройки:
  - размер курсора,
  - smoothing factor,
  - фон (solid/gradient).

### Результат

- Полноценный неразрушающий редактор проекта.

### Критерий готовности

- Пользователь может открыть запись, поправить зумы и увидеть корректное превью.

---

## Этап 6. Export Pipeline (Wave 4) — Выполнено

### Задачи

- Реализовать рендер композиции через Remotion.
- Передать результат в FFmpeg sidecar.
- Экспортировать финальный MP4 с целевым разрешением.
- Прогресс-бар и обработка ошибок экспорта.

### Результат

- Кнопка Export дает готовый видеофайл.

### Критерий готовности

- Экспорт в MP4 проходит без падений на тестовых проектах 1-5 минут.

---

## Этап 7. Интеграция, стабилизация, QA (Wave 5)

### Задачи

- End-to-end сценарии: Record -> Edit -> Export.
- Проверка синхронизации видео и событий.
- Проверка High-DPI координат (Windows scaling 100/125/150%).
- Профилирование и устранение узких мест.
- Подготовка MVP release build.

### Результат

- Стабильный релиз-кандидат Windows MVP.

### Критерий готовности

- Проходит набор QA сценариев без blocker-багов.

---

## 5. Параллелизация через AI-агентов

Для ускорения работ делим поток на независимые треки:

1. Track A (Core Capture): Recorder + Telemetry.
2. Track B (Algorithms): Auto-zoom + Smoothing.
3. Track C (Editor UI): Timeline + Settings + Preview.
4. Track D (Export): Remotion + FFmpeg + Progress/Errors.
5. Track E (QA/Infra): сценарии, smoke/e2e, стабилизация.

Синхро-точки (merge points):

- M1: после Этапа 1 (схемы данных).
- M2: после Этапа 3 (живой поток запись + телеметрия).
- M3: после Этапа 6 (экспорт).

---

## 6. Критерии готовности MVP (Definition of Done)

MVP считается завершенным, если:

1. Можно записать экран и получить raw video без курсора.
2. События телеметрии корректно записываются и синхронизированы.
3. Авто-зум работает на кликах, сглаживание курсора заметно улучшает движение.
4. Пользователь может вручную редактировать zoom-сегменты на таймлайне.
5. Экспорт выдает корректный MP4.
6. Проходят QA сценарии Record -> Edit -> Export.

---

## 7. Реестр рисков и меры

1. Риск: рассинхрон времени между видео и телеметрией.
   - Мера: единый time-base и синхронизация при старте записи.

2. Риск: смещение координат на High-DPI.
   - Мера: нормализация координат через scale factor монитора.

3. Риск: деградация производительности в превью/экспорте.
   - Мера: профилирование, ограничение MVP (1080p30), оптимизация кадрового пайплайна.

4. Риск: нестабильность UI Automation контекста.
   - Мера: fallback-область вокруг курсора, асинхронный запрос контекста.

---

## 8. План после MVP (Phase 2)

После выпуска Windows MVP:

1. Порт захвата и контекста на macOS (ScreenCaptureKit + AX API).
2. Вебкамера/аудио треки.
3. Motion blur, scroll-follow, расширенные стили курсора.
4. Оптимизация экспорта для 4K/60fps.
